name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    env:
      AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
      AWS_REGION: ${{ vars.AWS_REGION }}
      ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      # --- Tests + JUnit output ---
      - name: Run tests (JUnit output)
        run: |
          mkdir -p test-results
          npm test
          echo "Contents of test-results:"
          ls -la test-results
        env:
          JEST_JUNIT_OUTPUT_DIR: test-results
          JEST_JUNIT_OUTPUT_NAME: junit.xml
          JEST_SUITE_NAME: ci-demo-jest

      - name: Verify JUnit report exists
        run: test -f test-results/junit.xml

      - name: Publish test results to CloudBees Unify
        uses: cloudbees-io-gha/publish-test-results@v2
        with:
          cloudbees-url: https://api.cloudbees.io
          test-type: junit
          results-path: test-results/junit.xml

      - name: Upload JUnit report to GitHub Actions
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: test-results/junit.xml

      # =========================
      # ECR push + Unify artifact registration (main only)1
      # =========================

      - name: Assert AWS_ROLE_ARN secret is set
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          if [ -z "${{ secrets.AWS_ROLE_ARN }}" ]; then
            echo "AWS_ROLE_ARN secret is EMPTY or missing."
            exit 1
          fi
          echo "AWS_ROLE_ARN secret is present (masked)."

      - name: Show OIDC token claims (safe)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          TOKEN_JSON=$(curl -sH "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=sts.amazonaws.com")
          TOKEN=$(echo "$TOKEN_JSON" | python -c "import sys, json; print(json.load(sys.stdin)['value'])")
          PAYLOAD=$(echo "$TOKEN" | cut -d '.' -f2 | python -c "import sys,base64,json; p=sys.stdin.read().strip(); p+='='*((4-len(p)%4)%4); print(json.dumps(json.loads(base64.urlsafe_b64decode(p)), indent=2))")
          echo "$PAYLOAD"
      
      - name: Configure AWS credentials (OIDC)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: "${{ secrets.AWS_ROLE_ARN }}"
          aws-region: "${{ vars.AWS_REGION }}"
          role-skip-session-tagging: true

      - name: Login to Amazon ECR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to ECR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          IMAGE_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${{ github.run_number }}"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          echo "IMAGE_URI=$IMAGE_URI"

          docker build -t "$IMAGE_URI" .
          docker push "$IMAGE_URI"

      - name: Compute image digest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: imgdigest
        run: |
          docker pull "$IMAGE_URI"
          DIGEST="$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE_URI" | awk -F@ '{print $2}')"
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "Pushed digest: $DIGEST"

      - name: Register Docker image artifact in CloudBees Unify
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: cloudbees-io-gha/register-build-artifact@v3
        with:
          cloudbees-url: https://api.cloudbees.io
          name: ci-demo-image
          version: ${{ github.run_number }}
          url: ${{ env.IMAGE_URI }}
          digest: ${{ steps.imgdigest.outputs.digest }}
          type: docker
          label: github-actions,ci-demo,ecr
          commit: ${{ github.sha }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}
          ref: ${{ github.ref }}

      # =========================
      # Vulnerability scan publish to Unify (main only)
      # =========================

      - name: Save image to tar for scanning
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: docker save "$IMAGE_URI" -o image.tar

      - name: Trivy scan and publish vulnerabilities to CloudBees Unify
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: cloudbees-io-gha/trivy-scan-publish@v2
        with:
          cloudbees-url: https://api.cloudbees.io
          binary-tar-path: image.tar
